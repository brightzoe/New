### 数据在计算机中存储中的表示

浮点数一般使用 8 个字节表示，64bit
最左是符号，然后十一位为指数

- 指数范围-1023-1024, 指数部分使用原码存储，原码范围 0-2047,0 表示-1023
- 指数不用补码：从左到右扫描即可比较大小。
- 浮点数不够精确则更多用于对比大小，提高大小比较效率
- 程序中很少判断两个浮点数相等，更多判断他们的差的绝对值是否小于某个精度。小数部分最高精度 Number.EPSILON
  不存储底数的整数部分，因为底数的整数部分总是 1, 可以让二进制状态有效位数为 53 位
- 有效位数 53 位，可以表达的最大精确数 2\*\*53-1 为 `Number.MAX_SAFE_INTEGER`. 大于这个范围的数是可以表示的，但不能保证精确，溢出的位会被截断
- 整数部分使用的越多，小数部分有效位数越少。即数值越大，小数部分的精度越低。

IEEE754 标准：二进制浮点顺运算标准

- 双精度浮点数使用 8 字节表示，指数部分 11bit, 底数 62bit
- 单精度浮点数使用 4 字节表示，指数部分 8bit, 底数 23bit

### URL 网址

- 格式： 协议：//主机地址+目录路径+参数
- 常用协议
  ![常用协议](https://cdn.jsdelivr.net/gh/brightzoe/img/xieyi.png)

### 浏览器及其内核

![](https://cdn.jsdelivr.net/gh/brightzoe/img/browser.png)

## 万维网是如何工作的

![客户端和服务器](https://cdn.jsdelivr.net/gh/brightzoe/img/20200105191449.png)

- 网络连接：允许你在互联网上发送和接受数据。基本上和你家到商店的街道差不多
- TCP/IP: 传输控制协议和因特网互连协议是定义数据如何传输的通信协议。这就像你去商店购物所使用的交通方式，比如汽车或自行车。
- DNS: 域名系统服务器像是一本网站通讯录。浏览器需要找到存放你想要的网页的服务器，才能发送 HTTP 请求到正确的地方。就像你要知道商店的地址才能到达那。
- HTTP: 超文本传输协议是一个定义客户端和服务器间交流的语言的协议（protocol ）。就像你下订单时所说的话一样。
- 组成文件：一个网页由许多文件组成，就像商店里不同的商品一样。这些文件有两种类型：
  - 代码 : 网页大体由 HTML、CSS、JavaScript 组成，不过你会在后面看到不同的技术。
  - 资源 : 这是其他组成网页的东西的集合，比如图像、音乐、视频、Word 文档、PDF 文件。

### 发生了什么？

当你在浏览器里输入一个网址时（在我们的例子里就是走向商店的路上时）；

1. 浏览器在域名系统（DNS）服务器上找出存放网页的服务器的实际地址（找出商店的位置）。
2. 浏览器发送 HTTP 请求信息到服务器来请拷贝一份网页到客户端（你走到商店并下订单）。所有在客户端和服务器之间传递的数据都是通过互联网使用 TCP/IP 协议传输的。
3. 服务器同意客户端的请求后，会返回一个“200 OK”信息，意味着“你可以查看这个网页，给你～”，然后开始将网页的文件以数据包的形式传输到浏览器（商店给你商品，你将商品带回家）。
4. 浏览器将数据包聚集成完整的网页然后将网页呈现给你（商品到了你的门口 —— 新东西，好棒！）。

### HTTP 协议

HTTP 协议定义客户端和服务器之间交互的消息内容和步骤
![HTTP的基本思路](https://i.loli.net/2020/07/08/qY4hsfryb6PpAaF.png)
URI 统一资源标识符:代表访问目标 Uniform Resource Identifier
![HTTP主要方法](https://i.loli.net/2020/07/08/JdW7esh3c2GQlwk.png)
![HTTP消息的格式](https://i.loli.net/2020/07/08/4Gu5YTNeUvSJl8H.png)
![响应消息的状态码](https://i.loli.net/2020/07/08/eqmHZIw81uyJB53.png)

### DNS 解析

真正的网址是一串数字，比如 10.230.217.105，这叫 IP 地址，代表互联网上一个独特的位置。但并不好记忆，DNS 就是将域名与实际的 IP 地址相匹配的特殊服务器，达到让人使用域名，路由器使用 IP 地址的目的。
例如 IP Checker 可以通过域名查找 IP 地址。
解析器向 DNS 服务器发出查询，接收服务器返回的响应消息，响应消息包含查询到的 IP 地址。

#### DNS 解析器

解析器包含在操作系统的 Socket 库(网络开发的一种标准库，其中包含的程序组件可以让其他的应用调用操作系统的网络功能)中。
`nslookup www.baidu.com`

- 调用解析器：`gethostbyname("www.xx.xx")`
- 计算机内部：控制流程转移 ![](https://i.loli.net/2020/07/07/AJBEzOsc7MYndhD.png)

#### DNS 服务器

DNS 服务器的基本工作就是根据需要查询的域名和记录类型查找相关的记录，并向客户端返回响应消息。
其中，来自客户端的查询消息包含以下 3 种信息。

- 域名
  服务器、邮件服务器（邮件地址中@后面的部分）的名称
- Class
  在最早设计 DNS 方案时，DNS 在互联网以外的其他网络中的应用也被考虑到了，而 Class 就是用来识别网络的信息。不过，如今除了互联网并没有其他的网络了，因此 Class 的值永远是代表互联网的 IN
- 记录类型
  表示域名对应何种类型的记录。例如，当类型为 A 时，表示域名对应的是 IP 地址；当类型为 MX 时，表示域名对应的是邮件服务器。对于不同的记录类型，服务器向客户端返回的信息也会不同。
  类型：PTR,CNAME,NS,SOA...

DNS 服务器上事先保存有前面这 3 种信息对应的记录数据。
DNS 服务器中的所有信息都是按照域名以分层次的结构来保存的。域名中右边的部分层级高。
上级 DNS 服务器保管着所有下级 DNS 服务器的信息。
com、jp：顶级域，上面还有一层：. 根域，一般省略，但真实存在，根域的 DNS 服务器信息保存在互联网所有 DNS 服务器中。
DNS 服务器的缓存功能，加快服务器的响应。

#### IP 地址

IP 地址和现实中的地址一样，不能重复。
局域网都是基于 TCP/IP 思路设计的。TCP/IP 的结构就是由一些小的子网，通过路由器连接起来组成一个大的网络。这里的子网可以理解为用集线器连接起来的几台计算机，我们将它看作一个单位，称为子网。将子网通过路由器连接起来，就形成了一个网络。
![TCP/IP的结构](https://i.loli.net/2020/07/08/LubEBqs8cdxnMY2.png)
在 IP 地址的规则中，网络号和主机号连起来总共是 32 比特，8 比特为 1 组。利用子网掩码来区分网络号和主机号。
IP 地址的表示方法：![IP 地址的表示方法](https://i.loli.net/2020/07/07/bJ7BuNd9Om6TlWe.png)
子网掩码：转化为 2 进制，前面全 1，后面全 0,1 对应的 ip 地址部分是网络号，0 对应主机号；网络号相同的在同一个局域网里面；如 192.168.88.2/255.255.255.0 192.168.88.2/24
网络地址：ip 地址与子网掩码做与运算，结果就是网络地址
**IP 地址的主机号**

- 全 0：表示整个子网
- 全 1：表示向子网上所有设备发送包，即“广播”

### 委托协议栈向 Web 服务器发送消息

向操作系统内部的协议栈发出委托时，需要按照指定的顺序来调用 Socket 库中的程序组件。
收发数据的操作分为若干个阶段，可以大致总结为以下 4 个。

1. 调用 Socket 库中的 socket 程序组件创建套接字（创建套接字阶段）
2. 将管道连接到服务器端的套接字上（连接阶段）调用 Socket 库中的名为 connect 的程序组件,需要指定描述符、服务器 IP 地址和端口号.

- 描述符：应用程序用来识别套接字的机制
- IP 地址:识别具体是哪个网络硬件
- 端口号：用来识别具体的套接字。Web 是 80 号端口，电子邮件是 25 号端口，是规定好的。

3. 收发数据（通信阶段）
4. 断开管道并删除套接字（断开阶段）
   ![](https://i.loli.net/2020/07/08/iJ4X3E72PwaYUCo.png)

### 协议栈和网卡

![协议栈的内部结构](https://i.loli.net/2020/07/08/6vmGZkOwjTzItJn.png)
浏览器、邮件等一般应用程序收发数据时用 TCP;DNS 查询等收发较短的控制数据时用 UDP。
**套接字具体是啥？**套接字中记录了用于控制通信操作的各种控制信息，协议栈则需要根据这些信息判断下一步的行动。例如通信对象的 IP 地址、端口号、通信操作的进行状态等。
显示套接字 `netstat -ano`

- 通信操作中使用的控制信息分为两类。
  （1）头部中记录的信息，在 TCP 协议的规格中进行了定义。头部是用来记录和交换控制信息的。
  （2）套接字（协议栈中的内存空间）中记录的信息，用来控制协议栈操作。
#### 连接
  实际上是通信双方交换控制信息，在套接字中记录这些必要信息并准备数据收发的一连串操作，像上面提到的客户端将 IP 地址和端口号告知服务器这样的过程就属于交换控制信息的一个具体的例子。
  连接操作的第一步是在 TCP 模块处创建表示连接控制信息的头部.通过 TCP 头部中的发送方和接收方端口号可以找到要连接的套接字。

#### 收发数据

数据收发操作是从应用程序调用 write 将要发送的数据交给协议栈开始的，协议栈收到数据后执行发送操作。
协议栈收到数据会将数据存放在内部的发送缓冲区中，并等待应用程序的下一段数据。**如何判断发送时机？**

1. 第一个判断要素是每个网络包能容纳的数据长度，MTU。
   MTU：一个网络包的最大长度，以太网中一般为 1500 字节。
   MSS：除去头部之后，一个网络包所能容纳的 TCP 数据的最大长度。
   ![](https://i.loli.net/2020/07/08/xyjnfm2w34Tp5SJ.png)
2. 时间。协议栈内部有个计时器，当应用程序发送数据的频率不高的时候，如果每次都等到长度接近 MSS 时再发送，可能会因为等待时间太长而造成发送延迟。

- 网络包已经装好数据并发往服务器了，但数据发送操作还没有结束。TCP具备确认对方是否成功收到网络包，以及当对方没收到时进行重发的功能，因此在发送网络包之后，接下来还需要进行确认操作。
- 接收方返回ACK号给发送方——确认响应。
- TCP采用这样的方式确认对方是否收到了数据，在得到对方确认之前，发送过的包都会保存在发送缓冲区中。如果对方没有返回某些包对应的ACK号，那么就重新发送这些包。
> 因此，网卡、集线器、路由器都没有错误补偿机制，一旦检测到错误就直接丢弃相应的包。应用程序也是一样，因为采用TCP传输，即便发生一些错误对方最终也能够收到正确的数据，所以应用程序只管自顾自地发送这些数据就好了.

##### 错误补偿机制
- 返回ACK号的等待时间——超时时间：当网络传输繁忙时就会发生拥塞，ACK号的返回会变慢，等待时间需要稍长一点，但等待时间过长，包的重传会出现很大的延迟，所以等待时间不能设定为一个固定的值。TCP采用**动态调整等待时间**的方法，根据ACK号返回所需的时间来判断。
- 使用滑动窗口有效管理数据发送和ACK号。滑动窗口，就是在发送一个包之后，不等待ACK号返回，而是直接发送后续的一系列包。有可能出现发送报的频率超过接收方处理能力的情况， 数据将暂存到接收缓冲区中，能够接受的最大数据量称为窗口大小。
> 提高收发数据的效率：返回ACK号和更新窗口合并。

### 断开连接并删除套接字
断开连接后，套接字并不会立即被删除，而是会等待一段时间之后再被删除。


### IP 与以太网的包收发操作

TCP 模块在执行连接、收发、断开等各阶段操作时，都需要委托 IP 模块将数据封装成包发送给通信对象。
网络包是由头部和数据两部分构成。
TCP 为什么设置得如此复杂？ 需要将数据高效且可靠的发送给对方。为了实现可靠性，我们需要确认对方是否收到了我们发送给的数据，如果没有还需要再发一遍。为了实现高效的传输，需要避免重发已经送达的包，只重发出错的或未送达的包。
如果只有一个包就可以解决的短数据，适合使用**UDP**。UDP 只需要在应用程序获得的数据前面加上 UDP 头部，然后交给 IP 进行发送。接收就是根据 IP 头部中的接收方和发送方 IP 地址，以及 UDP 头部中的接收方和发送方端口号，找到相应的套接字并将数据交给相应的应用程序。
`socket = dgram.createSocket('udp4')`
`socket.bind(555)`
`socket.on('message',(msg,info)=>{console.log(info,msg.toString())})`
还有另一个场景会使用 UDP，就是发送音频和视频数据的时候。音频和视频数据必须在规定的时间内送达，一旦送达晚了，就会错过播放时机，导致声音和图像卡顿。

### 数据包是什么意思？

基本上，当数据在 Web 上传输时，是以成千上万的小数据块的形式传输的。大量不同的用户都可以同时下载同一个网页。如果网页以单个大的数据块形式传输，一次就只有一个用户下载，无疑会让 Web 非常没有效率并且失去很多乐趣。

## 计算机网络是典型的分层结构

- 物理层
- 链路层
- 网络层
- 传输层
- 应用层

### 物理层

- 设备间的物理连接，可以有线也可以无线。网线/WiFi/4G，传递 0，1 电信号
- 解决信号的调制与解调，转换数字信号和模拟信号
- 网卡：拥有 MAC 地址，使得用户可以通过网线或无线相互连接
- 曼彻斯特编码：加倍信号跳变频率，网络设备支持的频率固定，用来减半传播数据的大小。
- `ipconfig /all`查看网络配置

### 链路层

将比特数据流进行分组，完成从比特到以太网帧的服务（令牌环 / 总线型结构 / 交换机三种传播结构）

- 以太网协议：以太网帧：链路层传播的数据包
- MAC 地址：计算机网卡的唯一地址
- 总线型结构：所有的网点和同一条总线连接
- 交换机：一台机器，多个接口连接网络设备，可以识别每台连接的网络设备的 MAC 地址
- ARP 协议：address resolution protocol(地址解析协议), 通过广播获得 MAC 地址。将 ip 地址转化为 MAC 地址并记录对应关系，命令行 arp -a 可查看所有记录
  抓包软件：wireshark，抓取以太网帧数据包
  ARP 欺骗：假冒广播寻找的 IP 地址；网管交换机：记录每个网口对应的 ip 地址，MAC 地址，防止欺骗
  ARP 风暴： 高频率发送 ARP 广播，占用网络资源
  ping: 在命令行输入 ping ip 地址，查看和目标地址是否可以互动

### 网络层

多个网络点之间的中转和传输，机器到机器，子网->IP 协议

- 路由器：多个接口连接不同的子局域网，每个接口的 IP 地址（网关地址）不一样；
- 路由表：网关发过来的 ip 地址会进入路由器内部的路由表，其指导后续的网络传播方向 ；
- 家用路由器（NAT 路由器 Network address transition）： 和上面的路由器不一样；里面是一个路由器和一个交换机，相当于具有链路层和网络层功能。
- IP 分片 /IP 重组：IP 有关数据大小（IP 总长度）大于以太网帧负载，需要分开传输后再重组
- 0.0.0.0 ：代表任意的 ip 地址，不能作为目的地址使用
- 127.x.x.x 以 127 开头的 ip 地址都指向本机
- IP 报头：记录 ip 地址有关信息，本身储存在以太网帧负载里面
  - 版本（IPv4/IPv6），首部长度，总长度 标识（第几个分片）
  - 协议（解析 ip 地址的协议），首部校验和（哈希校验）
  - 源 IP 地址 / 目标 IP 地址
  - 数据（可选）
  - 生成时间（TTL）: IP 包头在网络中最多可以中转的次数，每遇到路由器中转一次减一，到 0 路由器就不传播扔掉该数据（路由会返回给发送者在哪一个路由器地址被扔掉，利用该特性可以追踪路由 cmd - tracert baidu.com），可以防止环状循环传播； - 在传播过程中 TTL 和首部校验和会变化
    -ICMP 协议：每个路由回复数据传播状态所要用到的协议

### 传输层

网络数据的传输 (UDP/TCP 协议），端口到端口（应用程序到应用程序）

- 端口：标识数据包给到哪个软件，用一个数字标识
- UDP：用户数据报协议（UDP，User Datagram Protocol），UDP 为应用程序提供了一种无需建立连接就可以发送封装的 IP 数据报的方法
- 包裹在 ip 的数据里面；包括源端口 / 目的端口 / 长度 / 校验和 / 数据 - UDP 的广播地址为 255.255.255.255，当 ip 地址为广播地址时，所有的端口都可以接收该以太网帧
- 缺点：不保证送达，数据包很小，不能保证按照发送顺序送达
- 优点：低延迟，丢包也不重发；如游戏，电话语音 - 模型
  udp 仅在 ip 上加了端口，每个 udp 端口是对等的，任何一个 udp 端口也可以向任何其它的 udp 端口发消息，不局限于只能为某个端口发；
  发送的消息不保证能送达。
  不存在服务器 / 客户端一说，没有连接的概念。

- TCP：传输控制协议（Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议
  TCP 四元组：源 ip, 目的 ip，源端口，目的端口；确定网络中独一无二的连接
  TCB:TCP 服务器和客户端连接时创造的内存片段
  TCP 的包头 - 包裹在 ip 的数据里面 - 源端口 / 目的端口（16bit,2\**16 次方个端口） - 头部长度 / 保留位 - 顺序号 / 确认号 ：按序发送，按序接收；都是一个相对值，相对第一个随机的序列号（安全性高） - 标识符
  SYN（握手包）；FIN（挥手包）；ACK（表示确认号正确）； - 窗口大小：先读取完窗口内的数据，读完数据后滑动窗口到后面的数据包片段；调整窗口大小实现流量控制，窗口越大数据传播数据越快； - 选项（窗口缩放因子 / 时间戳 / 支持 SACK 等等）
  TCP 半开状态：即一侧关闭了连接，不再发送数据，但可以接收数据，直至对侧也关闭了连接；另一侧没有关闭连接，仍可以发送数据。
  拥塞控制 - 慢启动 ：刚开始网速慢 - 和式增加：线性增加网速 - 积式减少：发生拥塞或者错误时网速指数减少 - bbr 算法：发送速率非常大，做到刚好不丢包的速率（传输中数据包的数量为带宽*延迟）
  时间戳
  TCP 时间戳用于“防止序列号回绕算法”，即防止序列号重复，时间戳不会重复，永远都是递增的
  选择确认（selective acknowledgment，SACK） - 允许接收的不连续的 TCP 流，只需要重发丢包的部分 TCP 流·，而不用所有 TCP 流重发 - SACK 选项并不是强制的，仅当双端都支持时才会被使用
  TCP 的 3 个阶段 - 建立连接，握手 - 三次握手（客户端请求连接，服务器同意连接，客户端表示收到服务器的消息），保证双方连接的正确性； - 传输（确认，重传，编号） - 确认数据是否正确 - 数据错误时重新传 - 每个字节都有一个顺序号和确认号，每完成一次数据传输更新编号 - 相互挥手，数据传输结束，连接断开
  -4 次挥手（客户端请求断开，服务器表示收到，服务器请求断开，客户端表示收到）
  -3 次挥手（客户端请求断开，服务器表示收到并同时请求请求断开，客户端表示收到）只有刚好双方都没有该数据流任务时才有 3 次挥手
- TLS/SSL 基于 TCP 上的传输加密层，使数据在传输过程中不被中途的路由器获取内部所有信息

  - 非对称加密
  - 发送方的一对密钥（公钥 p1, 私钥 s1）；接收方的一对密钥（公钥 p2, 私钥 s2）
    公钥是公开的，双方都有彼此公钥
    发送方发送 P2(S1(M)), 接收方通过 P1(S2(P2(S1(M))) 解码出 M
    S2 解码 P2,P1 解码 S1，实现秘密通信

  ### 应用层

  - 在传输层的数据协议之上的另一种协议（软件以应用层的协议解析其它软件发来的数据）
    \*DNS：Domain Name System 将域名转化为 ip 地址的协议 - 包裹在 UDP 的数据里 - dhcp 服务器自动分配 DNS 地址，也可以自己填写；一般填写离自己最近的 DNS 服务器地址，速度更快；114.114.114.114/114.114.115.115 - DDNS ：动态 DNS,Dynamic Domain Name Server，动态域名服务，是把互联网域名指向可变 IP 地址的系统；DNS 只是提供了域名和 IP 地址之间的静态对应关系，当 IP 地址发生变化时，DNS 无法动态的更新域名和 IP 地址之间的对应关系，从而导致访问失败。 - 全球只有 13 台根域名服务器 - DNS 负载均衡：一个域名指向一组机器
    - dhcp 协议 动态主机配置协议（Dynamic host configuration protocol）
      - 局域网里面有 dhcp 服务器 ，它会告诉新来的网络设备一个配置信息（ip 地址，网关，dns 等信息），设备会自动设置这些信息然后可以访问网络
      - ip 地址租期：dhcp 分配的 ip 地址有限，每个设备的 ip 地址都有一个租用时间，网络设备长时间未访问网络 dhcp 会收回 ip 地址，不过一般网络设备都会自动续期
    - https: 由 HTTP 进行通信，但利用 SSL/TLS 来加密数据包 ,HTTP over TLS;
      - 首次通信需要一个第 3 方 CA 机构，防止有人中途冒充接对方
      - CA 其有一对密钥（公钥 RP, 私钥 RS）认证过程如下：
        - 其拿到发送方域名，公钥 P1, 再用自己的私钥 RS 对发送方数据进行电子签名，再将整个信息进行哈希处理，得到一个类型 MD5 值，电子证书发给接收方
        - 接收方确认 MD5 值无误后用 CA 机构的公钥解码得到发送方的域名和公钥，核对无误后即可以同意连接，后续双方就可以进行 TLS 加密通信
